<html>
<!--******************************************************************************************************/
/** Weather Web Data Connector For Tableau																**/
/** Gets 5 day weather forecast from OpenWeatherMap API for list of cities in chosen country		    **/
/** Author Alex Ross 																					**/
/** Version 1.1 updated for changes to api in 9.1 beta 2            									**/
/** Version 1.2 remove asynchronous calls to openweathermaps due to performance issues					**/
/*******************************************************************************************************-->
<meta http-equiv="Cache-Control" content="no-store" />

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Title Core CSS -->
    <title>Weather Web Data Connector</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/stylish-portfolio.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

    <script
  src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g="
  crossorigin="anonymous"></script>
    <script src="js/tableauwdc-1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
	
        (function() {
            var APPID = "e6c74ed5c149407c48302ca8088f0f2d"; //APPID from OpenWeatherMap.org

            function init() {
                tableau.initCallback();
            }

            function shutdown() {
                tableau.shutdownCallback();
            }

            //returns a URL for 5 day forecast for given city from the OpenWeatherMap API
            function buildUrl(cityid) {
                var url = 'http://api.openweathermap.org/data/2.5/forecast/daily?id=' + encodeURIComponent(cityid.toString()) + "&cnt=5&units=metric" + "&APPID=" + APPID;
                return url;
            }

            var myConnector = tableau.makeConnector();

            myConnector.getColumnHeaders = function() {
                //setup field names and types to store weather data
                var fieldNames = ['COUNTRY', 'CITY ID', 'CITY', 'DAYTEMP', 'MINTEMP', 'MAXTEMP', 'NIGHTTEMP', 'EVETEMP', 'MORNTEMP', 'PRESSURE', 'HUMIDITY', 'DATE', 'MAIN', 'DESCRIPTION', 'ICON', 'SPEED', 'DEGREES', 'CLOUD', 'LAT', 'LON'];
                var fieldTypes = ['string', 'float', 'string', 'float', 'float', 'float', 'float', 'float', 'float', 'float', 'float', 'date', 'string', 'string', 'string', 'float', 'float', 'float', 'float', 'float'];
                tableau.headersCallback(fieldNames, fieldTypes);
            }

            myConnector.getTableData = function(lastRecordToken) {

                if (!tableau) {
                    alert("weatherwebconnect getColumnHeaders- tableau NOT defined!");
                    return;
                }

                //tableau.log("weatherwebconnect - getTableData connectionData=" + tableau.connectionData);
                //tableau.log("weatherwebconnect - getTableData lastRecordToken=" + lastRecordToken);

                //country id selected by user
                var country = tableau.connectionData;

                //define list of top 300 city ids for OpenWeatherMap
                if (country == "GB") {
                    var cityids = [2633352, 2633373, 2633485, 2633521, 2633551, 2633563, 2633691, 2633708, 2633810, 2633858, 2633883, 2633948, 2633954, 2633976, 2634021, 2634032, 2634202, 2634308, 2634491, 2634552, 2634578, 2634677, 2634686, 2634715, 2634739, 2634853, 2634864, 2634873, 2634887, 2634910, 2635062, 2635281, 2635427, 2635650, 2635703, 2636177, 2636276, 2636389, 2636432, 2636465, 2636484, 2636486, 2636531, 2636616, 2636619, 2636663, 2636769, 2636841, 2636876, 2636882, 2636910, 2636940, 2637126, 2637142, 2637329, 2637343, 2637433, 2637487, 2637546, 2637627, 2637752, 2637802, 2637891, 2638077, 2638324, 2638419, 2638664, 2638671, 2638678, 2638785, 2638867, 2638960, 2638978, 2639022, 2639093, 2639272, 2639447, 2639506, 2639557, 2639563, 2639577, 2639660, 2639866, 2639897, 2639912, 2639928, 2639996, 2640101, 2640106, 2640194, 2640354, 2640358, 2640677, 2640681, 2640729, 2641022, 2641157, 2641170, 2641181, 2641224, 2641267, 2641430, 2641595, 2641673, 2641689, 2641690, 2641810, 2641843, 2642189, 2642214, 2642465, 2642593, 2642607, 2642705, 2643044, 2643097, 2643116, 2643123, 2643179, 2643186, 2643266, 2643339, 2643490, 2643567, 2643697, 2643741, 2644100, 2644204, 2644210, 2644319, 2644411, 2644487, 2644547, 2644597, 2644652, 2644660, 2644668, 2644688, 2644726, 2644737, 2644972, 2645313, 2645418, 2645605, 2645724, 2645753, 2645889, 2646032, 2646057, 2646088, 2646274, 2646327, 2646458, 2646504, 2646557, 2646807, 2646826, 2646867, 2646914, 2647057, 2647074, 2647138, 2647317, 2647349, 2647356, 2647400, 2647428, 2647461, 2647632, 2647639, 2647793, 2647948, 2647984, 2648026, 2648063, 2648182, 2648187, 2648208, 2648272, 2648404, 2648405, 2648438, 2648579, 2648657, 2648773, 2649258, 2649322, 2649578, 2649660, 2649672, 2649692, 2649723, 2649800, 2649808, 2650096, 2650225, 2650278, 2650396, 2650405, 2650497, 2650628, 2650657, 2650732, 2650752, 2650839, 2651123, 2651286, 2651347, 2651495, 2651500, 2651513, 2651654, 2651715, 2652002, 2652053, 2652221, 2652381, 2652513, 2652618, 2652696, 2652698, 2652885, 2652974, 2653075, 2653086, 2653137, 2653144, 2653224, 2653225, 2653228, 2653232, 2653261, 2653266, 2653305, 2653584, 2653680, 2653775, 2653822, 2653877, 2653883, 2653941, 2654187, 2654264, 2654308, 2654675, 2654710, 2654715, 2654728, 2654730, 2654755, 2654782, 2654938, 2654993, 2655009, 2655095, 2655138, 2655186, 2655198, 2655237, 2655262, 2655315, 2655351, 2655459, 2655523, 2655603, 2655613, 2655664, 2655672, 2655729, 2655785, 2655882, 2655984, 2656046, 2656070, 2656168, 2656173, 2656192, 2656194, 2656235, 2656281, 2656284, 2656396, 2656406, 2656490, 2656708, 2656719, 2656915, 2656955, 2657030, 2657324, 2657402, 2657540, 2657613, 2657770, 2657780, 2657832, 2657835, 3209584, 3345439, 6691227];
                }
                if (country == "FR") {
                    var cityids = [2967245, 2967421, 2967849, 2967870, 2967917, 2968054, 2968142, 2968176, 2968254, 2968482, 2968529, 2968653, 2968705, 2968748, 2969109, 2969257, 2969284, 2969392, 2969679, 2970072, 2970456, 2970761, 2970777, 2970797, 2970962, 2971041, 2971053, 2971549, 2972049, 2972191, 2972237, 2972284, 2972315, 2972328, 2972444, 2972742, 2972811, 2972893, 2973258, 2973385, 2973495, 2973675, 2973783, 2973841, 2974153, 2974389, 2974681, 2974733, 2975050, 2975446, 2975525, 2975536, 2975758, 2975921, 2976043, 2976179, 2976341, 2976984, 2977246, 2977295, 2977356, 2977821, 2977921, 2978072, 2978179, 2978640, 2979590, 2979783, 2980236, 2980291, 2980340, 2980558, 2980816, 2980916, 2981041, 2981206, 2981280, 2982235, 2982652, 2982681, 2982757, 2983011, 2983276, 2983362, 2983770, 2983990, 2984114, 2984513, 2984701, 2985034, 2986140, 2986495, 2986501, 2986930, 2987271, 2987805, 2987914, 2987967, 2988358, 2988507, 2988621, 2988758, 2989317, 2989460, 2990187, 2990189, 2990265, 2990355, 2990363, 2990440, 2990474, 2990611, 2990612, 2990919, 2990969, 2990970, 2990999, 2991214, 2992017, 2992061, 2992166, 2992292, 2992415, 2992703, 2992771, 2992938, 2993002, 2994048, 2994144, 2994160, 2994393, 2994497, 2994651, 2994798, 2995150, 2995206, 2995387, 2995469, 2995649, 2995750, 2995908, 2996148, 2996514, 2996568, 2996882, 2996944, 2997116, 2997577, 2997803, 2998056, 2998286, 2998324, 2998431, 2998975, 3000192, 3003093, 3003603, 3003737, 3003796, 3003952, 3004630, 3004871, 3005269, 3005866, 3006283, 3006414, 3006767, 3006787, 3007477, 3008218, 3009169, 3009223, 3009824, 3010025, 3012219, 3012621, 3012647, 3012649, 3012834, 3012937, 3013097, 3014078, 3014143, 3014646, 3014728, 3014856, 3015490, 3015689, 3016621, 3016702, 3016830, 3017253, 3017341, 3017910, 3019256, 3019265, 3019897, 3020020, 3020035, 3020062, 3020310, 3020495, 3020810, 3020832, 3020839, 3020850, 3021000, 3021372, 3021411, 3022530, 3022610, 3023141, 3023763, 3023924, 3024066, 3024223, 3024266, 3024297, 3024596, 3024597, 3024635, 3024783, 3025053, 3025055, 3025622, 3025892, 3026033, 3026075, 3026108, 3026141, 3026204, 3026467, 3026613, 3026637, 3027105, 3027422, 3027484, 3027487, 3027883, 3028133, 3028263, 3028542, 3028641, 3028808, 3029030, 3029096, 3029162, 3029227, 3029241, 3029276, 3029931, 3029974, 3030300, 3031005, 3031009, 3031133, 3031137, 3031582, 3031815, 3032179, 3032213, 3032797, 3032824, 3032833, 3033002, 3033123, 3033391, 3033791, 3034006, 3034475, 3034640, 3035403, 3035409, 3035681, 3035843, 3036016, 3036145, 3036433, 3036460, 3036784, 3036903, 3036935, 3037044, 3037423, 3037456, 3037538, 3037543, 3037598, 3037612, 3037656, 3037854, 3038213, 3038224, 3038230, 3038261, 3038334, 3038350, 3038354, 3038634, 3038789];
                }
                if (country == "DE") {
                    var cityids = [2803560, 2805753, 2805761, 2806142, 2806654, 2806914, 2807363, 2807465, 2808559, 2808720, 2809346, 2809889, 2809985, 2810678, 2812174, 2812197, 2812482, 2813040, 2814127, 2815330, 2816630, 2817065, 2817220, 2817311, 2817724, 2820087, 2820256, 2821029, 2821164, 2824948, 2825297, 2826099, 2826287, 2826595, 2828045, 2829901, 2831580, 2831708, 2831924, 2831948, 2832495, 2832521, 2833079, 2833564, 2834265, 2834282, 2834498, 2835342, 2835482, 2835537, 2836319, 2841590, 2841648, 2842632, 2842647, 2842884, 2843729, 2844588, 2844988, 2847645, 2847690, 2847736, 2848273, 2849647, 2849802, 2850174, 2850257, 2851746, 2852458, 2853292, 2853572, 2853574, 2853658, 2853969, 2854653, 2855047, 2855328, 2855745, 2856883, 2857129, 2857458, 2857798, 2857807, 2858738, 2860410, 2861632, 2861650, 2861934, 2861982, 2862026, 2862620, 2863840, 2863941, 2864118, 2864425, 2864475, 2865637, 2866135, 2866333, 2866905, 2867542, 2867996, 2869791, 2869894, 2870221, 2871039, 2871535, 2871983, 2871992, 2872079, 2872504, 2872582, 2873263, 2873891, 2874225, 2874230, 2874545, 2875107, 2875115, 2875392, 2875457, 2875881, 2876185, 2876865, 2877088, 2878234, 2878695, 2878838, 2878943, 2879139, 2879367, 2881062, 2881085, 2881276, 2881485, 2881885, 2882087, 2884509, 2885679, 2885734, 2886946, 2890485, 2891122, 2891524, 2892080, 2892518, 2892794, 2893264, 2893438, 2894003, 2894375, 2895044, 2895669, 2895992, 2896817, 2897132, 2897216, 2898111, 2898304, 2899449, 2902768, 2904789, 2904795, 2905455, 2905560, 2905891, 2906121, 2906376, 2906530, 2906595, 2907201, 2907669, 2907852, 2907911, 2909230, 2911240, 2911271, 2911298, 2911395, 2911520, 2911665, 2912621, 2913366, 2913761, 2917138, 2917540, 2917788, 2918632, 2918752, 2918840, 2918987, 2919054, 2920236, 2920478, 2921232, 2921466, 2922586, 2923543, 2923822, 2924585, 2924802, 2924915, 2925017, 2925034, 2925177, 2925192, 2925259, 2925550, 2925629, 2925832, 2926271, 2927268, 2927930, 2928396, 2928615, 2928751, 2928809, 2928963, 2929567, 2929600, 2929622, 2929670, 2929671, 2929802, 2930596, 2930776, 2930821, 2931521, 2931574, 2933882, 2933965, 2934246, 2934486, 2934662, 2934691, 2935022, 2935220, 2935517, 2935530, 2935825, 2936871, 2936977, 2937936, 2937959, 2938323, 2938913, 2939623, 2939658, 2939811, 2939819, 2939951, 2940132, 2940213, 2940231, 2940451, 2941497, 2941693, 2942627, 2943320, 2943560, 2944368, 2944388, 2945756, 2946111, 2946228, 2946447, 2947421, 2947444, 2949012, 2949186, 2950159, 2950344, 2950349, 2950438, 2950622, 2950978, 2951654, 2951825, 2951881, 2952984, 2953358, 2953386, 2953416, 2953504, 2954006, 2954172, 2954602, 2955272, 2955471, 2955936, 2956656, 2957773, 2958141, 2958595, 2959223, 2959279, 2959927, 3247449, 3336891, 3336893];
                }
                if (country == "ALL") {
                    var cityids = [53654, 98182, 104515, 108410, 113646, 115019, 124665, 128747, 160263, 170063, 170654, 184745, 188714, 232422, 264371, 276781, 294615, 311046, 323786, 325363, 360630, 361058, 379252, 418863, 498817, 520555, 524901, 625144, 683506, 703448, 745044, 750269, 756135, 890299, 891099, 909137, 922704, 953781, 962330, 964137, 993800, 1007311, 1070940, 1166548, 1166993, 1168197, 1169825, 1172451, 1174872, 1176734, 1177662, 1179400, 1185236, 1185241, 1214520, 1253573, 1255364, 1255634, 1257629, 1259229, 1259652, 1260086, 1261481, 1262180, 1264728, 1266049, 1267995, 1268295, 1268865, 1269515, 1269743, 1270926, 1271308, 1271951, 1273294, 1275631, 1275841, 1277333, 1278148, 1279233, 1279259, 1279945, 1298824, 1311874, 1336135, 1486209, 1496747, 1512569, 1526384, 1581130, 1609350, 1625084, 1625822, 1627896, 1633070, 1642911, 1645518, 1649378, 1650357, 1668341, 1673820, 1680106, 1681602, 1683859, 1687409, 1687714, 1687801, 1687888, 1688217, 1688725, 1688949, 1689236, 1689413, 1689969, 1689994, 1690033, 1690158, 1690295, 1690684, 1691488, 1699896, 1701668, 1704129, 1705545, 1706843, 1707321, 1712637, 1715348, 1716994, 1720681, 1726701, 1729571, 1730499, 1735161, 1788534, 1790630, 1790923, 1791247, 1792947, 1793346, 1793511, 1796236, 1797929, 1798422, 1799962, 1800163, 1801792, 1804430, 1805298, 1805518, 1805753, 1808722, 1808926, 1808963, 1809077, 1809858, 1813451, 1814087, 1814906, 1815286, 1835848, 1850147, 1853192, 1859642, 1880252, 2034937, 2036502, 2037013, 2037345, 2037355, 2038180, 2038632, 2063523, 2066954, 2077963, 2147714, 2152667, 2154219, 2158177, 2164025, 2170852, 2171360, 2174003, 2188371, 2220957, 2232593, 2253354, 2267226, 2276600, 2293538, 2298890, 2306104, 2314302, 2335204, 2335727, 2339354, 2408770, 2422465, 2440485, 2460596, 2507480, 2518277, 2519240, 2538475, 2553604, 2633842, 2634715, 2639268, 2640194, 2643123, 2643741, 2644972, 2646507, 2654675, 2655603, 2661568, 2673730, 2761369, 2911298, 2950159, 2964574, 2988507, 2992119, 3054643, 3121070, 3369157, 3390760, 3399415, 3405863, 3435789, 3441575, 3448439, 3451190, 3452925, 3464975, 3467865, 3469058, 3470127, 3515431, 3529612, 3633009, 3646738, 3652462, 3657509, 3663517, 3687925, 3688689, 3689147, 3718426, 3936456, 3981609, 4003757, 4011469, 4046332, 4058198, 4061206, 4069458, 4069553, 4071267, 4074267, 4086224, 4099974, 4106074, 4110443, 4110486, 4123271, 4143637, 4143861, 4164047, 4166628, 4173892, 4180512, 4186213, 4188985, 4190598, 4206882, 4209884, 4211083, 4236206, 4242790, 4254679, 4268854, 4273837, 4276248, 4282757, 4289629, 4292193, 4346014, 4347778, 4434069, 4440906, 4463523, 4584524, 4603001, 4733891, 4887398, 4905873, 4920512, 5174095, 5814616];
                }
                if (country == "US") {
                    var cityids = [4046332, 4047198, 4048332, 4048850, 4049979, 4051774, 4053200, 4054566, 4055696, 4058198, 4058553, 4061206, 4062577, 4063926, 4065282, 4065302, 4065965, 4066437, 4068590, 4069458, 4069553, 4071267, 4072767, 4073383, 4074267, 4074673, 4076784, 4081914, 4086224, 4086285, 4093048, 4094163, 4099974, 4105377, 4105879, 4106074, 4106458, 4110443, 4110486, 4113143, 4113951, 4113956, 4119972, 4122986, 4123271, 4123830, 4125402, 4129965, 4132093, 4135349, 4142290, 4142643, 4143319, 4143637, 4143658, 4143698, 4143861, 4144764, 4145381, 4146039, 4146206, 4148207, 4148659, 4148757, 4149077, 4151316, 4151416, 4154216, 4154465, 4156404, 4158591, 4158928, 4159335, 4161228, 4161438, 4161461, 4164047, 4164138, 4166628, 4166787, 4167797, 4169510, 4171010, 4171563, 4172086, 4173838, 4173892, 4174757, 4175637, 4176217, 4177542, 4177703, 4178003, 4179320, 4180386, 4180439, 4180512, 4184845, 4186213, 4186416, 4187055, 4188985, 4189785, 4190598, 4192205, 4194202, 4196688, 4198972, 4202672, 4206882, 4207400, 4207625, 4207783, 4209884, 4211083, 4221552, 4223871, 4227777, 4229546, 4233813, 4235724, 4236206, 4240679, 4240782, 4242790, 4243951, 4248205, 4248284, 4252548, 4254282, 4254671, 4254679, 4255673, 4256384, 4257227, 4258285, 4259418, 4260210, 4260329, 4262406, 4263108, 4263681, 4263850, 4268854, 4273359, 4273837, 4274236, 4275144, 4275586, 4276248, 4276588, 4277241, 4281730, 4282342, 4282497, 4282757, 4283845, 4289629, 4292193, 4295954, 4297354, 4297983, 4297999, 4305294, 4308922, 4311646, 4313697, 4326868, 4332494, 4335045, 4335796, 4346014, 4346913, 4347778, 4349337, 4350175, 4353962, 4356050, 4364990, 4367734, 4369964, 4374798, 4376623, 4379025, 4382072, 4388036, 4391354, 4397042, 4400289, 4407010, 4407066, 4415076, 4417642, 4434069, 4434465, 4435764, 4440906, 4455335, 4459467, 4460243, 4463523, 4464368, 4473158, 4477228, 4479207, 4482693, 4485973, 4487042, 4503665, 4504915, 4508722, 4509986, 4521816, 4522228, 4528793, 4535806, 4544349, 4553433, 4559831, 4561873, 4584524, 4603001, 4608657, 4614136, 4634671, 4634946, 4650946, 4658802, 4672989, 4683416, 4691930, 4692355, 4692400, 4693003, 4697616, 4699533, 4710826, 4716805, 4719457, 4722241, 4726206, 4726311, 4726440, 4727076, 4733891, 4735013, 4773677, 4776222, 4791259, 4794457, 4839822, 4853828, 4878703, 4885983, 4887398, 4890813, 4905687, 4905873, 4907959, 4913605, 4915764, 4920512, 4925006, 4927042, 4928118, 4930956, 4936008, 4943629, 4990729, 4994358, 5007655, 5014130, 5045360, 5074472, 5098909, 5100604, 5106825, 5124276, 5129603, 5129887, 5190679, 5206379, 5255882, 5263045, 5304391, 5318313, 5323810, 5325738, 5368361, 5381002, 5389489, 5391959, 5392171, 5392900, 5399020, 5417598, 5454711, 5475433, 5809844, 5856195];
                }
                if (country == "AU") {
                    var cityids = [2058430, 2059470, 2062276, 2063030, 2063036, 2063042, 2063056, 2063523, 2064340, 2064510, 2064546, 2064550, 2064655, 2064735, 2064874, 2064915, 2065078, 2065176, 2065594, 2065602, 2065665, 2065710, 2065740, 2066041, 2066052, 2066358, 2066524, 2066608, 2066653, 2066679, 2066756, 2066954, 2066957, 2066981, 2067070, 2067074, 2067086, 2067119, 2067260, 2067565, 2067760, 2068079, 2068110, 2068655, 2070998, 2071059, 2071860, 2073124, 2074113, 2074865, 2075265, 2075432, 2075720, 2077454, 2077895, 2077963, 2078025, 2079691, 2079692, 2079696, 2142245, 2142316, 2143285, 2144168, 2144502, 2144528, 2144604, 2144764, 2145110, 2145214, 2145532, 2145554, 2145875, 2146108, 2146142, 2146219, 2146268, 2147381, 2147497, 2147714, 2147756, 2147914, 2148431, 2149128, 2149475, 2150163, 2150615, 2151187, 2151437, 2152286, 2152659, 2152667, 2153778, 2154219, 2154445, 2154447, 2154537, 2154544, 2154672, 2154787, 2154796, 2154826, 2154849, 2154913, 2155092, 2155135, 2155412, 2155415, 2155416, 2155472, 2155542, 2155562, 2155710, 2155731, 2155742, 2155745, 2155750, 2155772, 2155783, 2155796, 2155858, 2155859, 2155862, 2156034, 2156049, 2156069, 2156298, 2156340, 2156345, 2156404, 2156643, 2156671, 2156694, 2156777, 2156813, 2156825, 2156853, 2156878, 2156927, 2156933, 2156934, 2157060, 2157090, 2157109, 2157161, 2157272, 2157331, 2157343, 2157355, 2157373, 2157495, 2157652, 2157698, 2157995, 2158020, 2158130, 2158151, 2158177, 2158220, 2158504, 2158538, 2158561, 2158626, 2158651, 2158744, 2158767, 2158839, 2158867, 2158874, 2159018, 2159185, 2159194, 2159220, 2159654, 2159683, 2159851, 2160053, 2160063, 2160113, 2160114, 2160232, 2160258, 2160297, 2160299, 2160336, 2160386, 2160413, 2160477, 2160493, 2160517, 2160519, 2160523, 2160560, 2160625, 2160735, 2160744, 2160751, 2160774, 2160880, 2160910, 2160922, 2160937, 2161072, 2161251, 2161376, 2161515, 2161658, 2162662, 2162683, 2162737, 2163055, 2163355, 2163701, 2163837, 2164025, 2164129, 2164206, 2164422, 2164771, 2164837, 2165087, 2165478, 2165798, 2165828, 2166368, 2167426, 2168305, 2168943, 2169068, 2169220, 2169535, 2170078, 2170089, 2170139, 2170260, 2170430, 2170577, 2170581, 2171069, 2171085, 2171320, 2171507, 2171722, 2171845, 2172106, 2172153, 2172517, 2172710, 2172797, 2172832, 2173099, 2173125, 2173323, 2173605, 2173911, 2174003, 2174400, 2174444, 2174933, 2175403, 2175819, 2176187, 2176225, 2176639, 2177069, 2177091, 2177233, 2177413, 2177541, 2177671, 2177756, 2178174, 2205628, 2205631, 2205970, 2205971, 2205988, 2206000, 2206006, 2206066, 2206068, 2206082, 2206116, 2207598, 2207611, 2207753, 2207762, 2207817, 2207880, 6255012, 6301965, 6533368, 6620339, 6697141, 7280463, 7281804, 7302638, 7932638, 7932640, 7932641];
                }
                if (country == "BR") {
                    var cityids = [3473267,3460523,
3470821,
3461724,
3465059,
3471005,
3403127,
3467796,
3460671,
3467026,
3407216,
3407797,
3401148,
3466696,
3466296,
3467452,
3470878,
3462535,
3464274,
3465748,
3470709,
3462996,
3464974,
3460738,
3470597,
3403566,
3465487,
3471374,
3462371,
3406442,
3463174,
3466933,
3460699,
3465284,
3470324,
3463762,
3465671,
3466779,
3461408,
3464547,
3408404,
3471393,
3399415,
3406318,
7874492,
3463011,
3407357,
3471039,
3468902,
3472848,
3465758,
3465105,
3407903,
3465713,
3461973,
3408100,
3470003,
3461888,
3404513,
3464073,
3402528,
3405870,
3467736,
3467673,
3404117,
3465764,
3460598,
3461824,
3471872,
3404722,
3460530,
3462956,
3404766,
3466547,
3472138,
3470073,
3401548,
3397967,
3460752,
3464739,
3471335,
3397936,
3398350,
3404020,
3460542,
3471196,
3465329,
3405940,
3463865,
3460974,
3463237,
3467542,
3398269,
3470353,
3469115,
3471715,
3403697,
3468014,
3466723,
3471368,
3461628,
3469516,
3461857,
3460774,
3464724,
3664207,
3461958,
3398920,
3472284,
3460734,
3463140,
3472638,
3402465,
3471451,
3464975,
3467261,
3665202,
3467693,
3402360,
3407194,
3471859,
3469968,
3401703,
3471422,
3461055,
3406910,
3461144,
3461871,
3406160,
3462964,
3463478,
3465527,
3465209,
3467577,
3468100,
3403611,
3400804,
3405006,
3467305,
3407440,
3464374,
3461786,
3460740,
3402000,
3462377,
3460584,
3472417,
3472254,
3471061,
3461879,
3464891,
3464460,
3466062,
3461550,
3471830,
3463920,
3467956,
3471683,
3460813,
3460648,
3463859,
3464618,
3466903,
3471758,
3466998,
3398105,
3468023,
3472609,
3408175,
3465769,
3470341,
3468436,
3398614,
3393768,
3460831,
3472969,
3399058,
3402229,
3468592,
3460825,
3461124,
3467197,
3398352,
3470177,
3405738,
3472248,
3467985,
3402721,
3468031,
3471846,
3470718,
3468157,
3401845,
3465320,
3461859,
3401283,
3467684,
3461129,
3462089,
3398691,
3460834,
3461465,
3470825,
3469601,
3471291,
3461311,
6316729,
3461874,
3466171,
3467865,
3467760,
3463605,
3403642,
3398856,
3471910,
3470369,
3462980,
3665199,
3461153,
3465083,
3467362,
3465228,
3468121,
3405380,
3406545,
3472766,
3460594,
3468894,
3397909,
3406196,
3461995,
3461498,
3465090,
3470052,
3470674,
3470451,
3664539,
3398570,
3402724,
3460629,
3463030,
3461525,
3464728,
3460963,
3664980,
3407243,
3470912,
3465476,
3460960,
3471896,
3465881,
3465944,
3470428,
3407882,
3408166,
3460644,
3465927,
3460728,
3397941,
3468215,
3407327,
3465624,
3466763,
3460826,
3462601,
3468403,
3466429,
3460620,
3471927,
3466436,
3467550,
3465196,
3470279,
3463432,
3472311,
3460773,
3468732,
3471949,
3461638,
3405792,
3461134,
3461528,
3461588,
3472808,
3460954,
3397898,
3468720,
3468425,
3664321,
3463939,
3461370,
3466692,
3398343,
3472370,
3404862,
3403687,
3461425,
3464329,
3461763,
3461620,
3407758,
3465731,
3400617,
3461563,
3461411,
3472338,
3461090,
3408274,
3471798,
3461444,
3471854,
3464255,
3461194,
3470142,
3385077,
3925212,
3472520,
3470636,
3469989,
3403208,
3468899,
3466704,
3462916,
3400740,
3460949,
3470858,
3465038,
3461501,
3402591,
3406961,
3460971,
3400752,
3462580,
3407980,
3460899,
3403941,
3466174,
3462557,
3460535,
3465342,
3467680,
3461910,
3405863,
3468615,
3460966,
3465164,
3462374,
3469984,
6316406,
3470264,
3465512,
3472869,
3406263,
3405924,
3470691,
3460723,
3461316,
3470117,
3398904,
3404545,
3469092,
3402613,
3399518,
3468570,
3398112,
3461941,
3401963,
3401992,
3461499,
3401109,
3466978,
3464688,
3408343,
3460718,
3461151,
3408424,
3468376,
3473964,
3461655,
3472287,
3470730,
3405812,
3397893,
3401138,
3460887,
3462022,
3398379,
3402271,
3469932,
3467978,
3464008,
3467081,
3403362,
3400567,
3469058,
3466041,
3468317,
3467512,
3471487,
3406996,
3465459,
3470776,
3468704,
3461565,
3467717,
3472603,
3460950,
3461481,
3472518,
3466481,
3470583,
3463900,
3461368,
3407669,
3403353,
3400558,
6693804,
3664078,
3466750,
3473157,
3398115,
3460730,
3469425,
3460764,
3403534,
3463066,
3468562,
3405616,
3462376,
3407407,
3925075,
3664659,
3469437,
3469136,
3404817,
3470127,
3398331,
3401340,
3465108,
3472825,
3472666,
3471848,
3472177,
3399132,
3406429,
3397969,
3471691,
3461606,
3398076,
3470470,
3408337,
3466537,
3461949,
3408368,
3467677,
3461680,
3398706,
3399506,
3401830,
3462315,
3471395,
3460748,
3461576,
3471428,
3398003,
3464809,
3405954,
3468879,
3460733,
3467319,
3467467,
3461017,
3468535,
3468858,
3471940,
3467530,
3467371,
3466261,
3467012,
3404558,
3460845,
3471849,
3472343,
3407258,
3453807,
3402655,
3464304,
3469540,
3400969,
3461519,
3470044,
3398569,
3460791,
3466988,
3471772,
3467272,
3465524,
3472048,
3466641,
3465721,
3465767,
3462378,
3398450,
3464100,
3461935,
3463422,
3461914,
3467747,
3464305,
7732959,
3461625,
3463698,
3401106,
3471766,
3468893,
3401545,
3397904,
3461013,
3468802,
3407378,
3471840,
3465644,
3471697,
3402429,
3468158,
3467877,
3467687,
3404833,
3464579,
3466698,
3460522,
3468560,
3468327,
3466902,
3466824,
3461789,
3463271,
3460516,
3397851,
3460513,
3460511,
3460484,
3397838,
6317344,
3460441,
3460370,
3460362,
3460355,
3460344,
3460267,
3460242,
3460232,
3460225,
3460214,
3397675,
3460200,
3397665,
3460186,
3460174,
3460172,
3460170,
3460148,
3460132,
3460107,
3460102,
3460087,
3460071,
3460068,
3925040,
3460064,
3392243,
3460005,
3459943,
3459925,
3459922,
3459869,
3397315,
3459796,
3397277,
3459785,
3459712,
3459667,
3397230,
3459550,
3397147,
3459505,
3459495,
3459462,
3459352,
3459342,
3458930,
3396601,
3459251,
3396769,
3459138,
3459126,
3459094,
3459035,
3396496,
3458902,
3458826,
3458786,
3458778,
3458746,
6317464,
3458696,
3396364,
3458662,
3458645,
3458632,
3458575,
3396277,
3396266,
3458498,
3458494,
3458481,
3458479,
3458449,
3458425,
3458406,
3458397,
3458329,
3458266,
3396048,
3396016,
3458245,
3395998,
3395981,
3458211,
3458147,
3458132,
3458131,
3395717,
3663529,
3663517,
3458049,
3457991,
3457952,
3457950,
3395503,
3457859,
3395473,
3457854,
3395458,
3457850,
3457819,
3457817,
3457772,
3395395,
3395380,
3457741,
3457736,
3457708,
3457692,
3457671,
3457595,
3457566,
3457528,
3457509,
3457484,
3457393,
3395077,
3457381,
3395062,
3457360,
3457359,
3457247,
3457191,
3457192,
3457147,
3457133,
3457107,
3394745,
3457025,
3457001,
3457000,
3456998,
3394661,
3394649,
3456944,
3394605,
3456873,
3456866,
3456863,
3456848,
3456827,
3456816,
3394549,
3456814,
3394500,
3394453,
3456735,
3456724,
3456696,
3394682,
3456593,
3456500,
3394116,
3456483,
3456412,
3456398,
3394023,
3456370,
3456368,
3456366,
3393972,
3456324,
3456322,
3456290,
3456285,
3456283,
3456240,
3456223,
3393876,
3456176,
3456166,
3456164,
3456160,
3456147,
3456138,
3456137,
3456127,
3456125,
3393832,
3456110,
3456102,
3456068,
3456060,
3393764,
3455923,
3393536,
3455908,
3393471,
3455785,
3455784,
3393465,
3455775,
3455769,
3455756,
3393452,
3455729,
3455689,
3455671,
3924948,
3393409,
3393400,
3455580,
3455553,
3455478,
3393264,
3474574,
3455459,
3455425,
3455416,
3455342,
3455298,
3455281,
3455161,
3455170,
3455168,
3393115,
3393106,
3455155,
3455152,
3455141,
3393091,
3455070,
3455065,
3455061,
3455051,
3455036,
3393017,
3393008,
3393001,
3392998,
3454954,
3454857,
3454847,
3454818,
3392887,
3454783,
3454763,
3454827,
3454690,
3392740,
3392734,
3454620,
3454578,
3392629,
3454407,
3392431,
3454358,
3454244,
3392368,
3454235,
3454231,
3454213,
3392345,
3454139,
3454131,
3454061,
3392251,
3392242,
3454031,
3392167,
3453926,
3392126,
3453896,
3924908,
3453837,
3392088,
3453827,
6317953,
3453777,
3453767,
3392054,
3453661,
3453659,
3453643,
3391991,
3453635,
3453622,
3453610,
3453605,
3453546,
3453542,
3453535,
3453639,
3453503,
3391908,
3453494,
3453478,
3453467,
3453457,
3453439,
3453435,
3453420,
3453406,
3453337,
3453315,
3453303,
3391571,
3391556,
3453245,
3453242,
3453240,
3453186,
3453150,
3453171,
3453078,
3453060,
3453014,
3452982,
3391412,
3452925,
3391397,
3452779,
3452775,
3452640,
3452623,
3662762,
3452599,
3924877,
3452525,
3452483,
3452465,
3452440,
3391220,
3452331,
3452324,
3452320,
3452237,
3452233,
3452216,
3452179,
3452141,
3452073,
3451931,
3390907,
3390901,
3451856,
3390760,
3451709,
3451704,
3451668,
3451650,
3451474,
3451383,
3390326,
3451357,
3451353,
3451329,
3451328,
3451261,
3662574,
3451242,
3451241,
3451234,
3451205,
3451202,
3451190,
3451152,
3390295,
3451138,
3451134,
3390288,
3451124,
3451102,
6318165,
3451071,
3451051,
3450964,
3450963,
3450909,
3450873,
3450843,
3390160,
3450832,
3450759,
3389860,
3450671,
3389822,
3450594,
3450563,
3450554,
3450404,
3450376,
3389673,
3450288,
3450283,
3389652,
3450272,
3450269,
3450232,
3450225,
3389622,
3450206,
3389609,
3450188,
3450144,
3389557,
3450083,
3450063,
3389361,
3389358,
3389321,
3449851,
3449847,
3449822,
3449793,
3449747,
3450157,
3391360,
3449948,
3389384,
3449936,
3449933,
3389353,
3449741,
3449720,
3449711,
3449707,
3449701,
3449696,
3449529,
3449521,
3449519,
3449518,
3449516,
3449500,
3449467,
3449433,
3449427,
3389006,
3388991,
3449350,
3449344,
3449340,
3449324,
3449319,
3449310,
3388868,
3388847,
3449195,
3449176,
3449116,
3449112,
3449099,
3662342,
3388714,
3449056,
3449053,
3449045,
3448903,
3448902,
3448877,
3448879,
3386567,
3388615,
3448846,
3448828,
3448825,
3448742,
3388443,
3388441,
3388435,
3448640,
3448639,
3448636,
3448632,
3448622,
3448616,
3388376,
3448596,
3388368,
3448558,
3388341,
3448552,
3448545,
3448533,
3448519,
3388318,
3448502,
3448455,
3388270,
3448453,
3388269,
3448439,
3448403,
3448351,
3388145,
3448300,
3448257,
3448227,
3448221,
3448219,
3448207,
3448136,
3448063,
3448031,
3448011,
3447998,
3447997,
3447969,
3387987,
3447961,
3447929,
3447928,
3662155,
3447854,
3387926,
3447839,
3447785,
3447779,
3447718,
3387786,
3447720,
3447690,
3387663,
3447651,
3447624,
3447597,
3447591,
3447562,
6318694,
3387604,
3447473,
3387296,
3447437,
3387266,
3447423,
3447399,
3387204,
3387202,
3447259,
3387115,
3447212,
3662075,
3387082,
3447186,
3447059,
3386931,
3447005,
3446979,
3446974,
3446880,
3446866,
3446847,
3446783,
3446753,
3446752,
3661980,
3446692,
3446682,
3661944,
3446652,
3446625,
3446621,
3386496,
3446606,
3446556,
3386449,
3446539,
3446500,
3386396,
3386372,
3446465,
3386361,
3446445,
3446400,
3446370,
3386279,
3386264,
3446295,
3386177,
3446232,
3446194,
3446138,
3446137,
3446130,
3446098,
3446087,
3446077,
3446065,
7874479,
3446038,
3386042,
3445993,
3445983,
3385980,
3385935,
3385922,
3445942,
3445941,
3445939,
3445859,
3445853,
3445849,
3445847,
3445839,
3445831,
3445782,
3445781,
3445764,
3385745,
3445746,
3385742,
3445713,
3445690,
3445679,
3445630,
3445597,
3445596,
3385592,
3445578,
3445575,
3385538,
3445500,
3445487,
3385504,
3385467,
3445459,
3445451,
3445446,
3445433,
3445418,
3445350,
3445307,
3445299,
3445162,
3445156,
3445153,
3385122,
3445133,
3385109,
3385106,
3445126,
3385088,
3445026,
3924679,
3445014,
3444997,
3444969,
3385022,
3444924,
3444914,
3384987,
3384986,
3444876,
3444866,
3444864,
3445348,
3444848,
3444823];
                }
                //parse lastRecordNumer as Integer as Tableau stores this as a string
                lastRecordToken = Number(lastRecordToken);

                // Return if lastRecordToken is greater than or equal to the size of cityids list
                if (lastRecordToken >= cityids.length) {
                    //if (lastRecordToken > 10) { //test with 10 cities
                    tableau.dataCallback([], lastRecordToken.toString(), false);
                    return;
                }

                var cityid = cityids[lastRecordToken];

				//build url to get data
                var connectionUrl = buildUrl(cityid);

                var xhr = $.ajax({
                    url: connectionUrl,
                    dataType: 'json',
                    success: function(data) {
                        var toRet = [];

                        //make sure we don't output anything for null values
                        if (data.list) {
                            var list = data.list;
                            var city = data.city;

                            //for each result write entry
                            for (x = 0; x < list.length; x++) {

                                //tableau.log("weatherwebconnect - getTableData city=" + city.name);
                                entry = {
                                    'COUNTRY': city.country,
                                    'CITY': city.name,
                                    'CITY ID': city.id,
                                    'DAYTEMP': list[x].temp.day,
                                    'MINTEMP': list[x].temp.min,
                                    'MAXTEMP': list[x].temp.max,
                                    'NIGHTTEMP': list[x].temp.night,
                                    'EVETEMP': list[x].temp.eve,
                                    'MORNTEMP': list[x].temp.morn,
                                    'PRESSURE': list[x].pressure,
                                    'HUMIDITY': list[x].humidity,
                                    'DATE': new Date(list[x].dt * 1000),
                                    'MAIN': list[x].weather[0].main,
                                    'DESCRIPTION': list[x].weather[0].description,
                                    'ICON': list[x].weather[0].icon,
                                    'SPEED': list[x].speed,
                                    'DEGREES': list[x].deg,
                                    'CLOUD': list[x].clouds,
                                    'LAT': city.coord.lat,
                                    'LON': city.coord.lon
                                };
                                toRet.push(entry);
                            }
                            // Call back to tableau with the table data and the new record number (this is stored as a string)
                            lastRecordToken = lastRecordToken + 1;
                            tableau.dataCallback(toRet, lastRecordToken.toString(), true);
                        } else {
                            tableau.abortWithError("No results found for city id: " + cityid);
                        }

                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        // add something to the log and return an empty set if there was problem with the connection
                        tableau.log("connection error: " + xhr.responseText + "\n" + thrownError);
                        tableau.abortWithError("error connecting to the openweathermaps API data source");
                    }
                });
            };

            tableau.registerConnector(myConnector);

            $(document).ready(function() {
                //register some input handlers
                $("#inputForm").submit(function() {
                    // This event fires when a button is clicked 
                    event.preventDefault();
                    var checkedBoxes = $('input[name=dataSourceName]:checked');
                    if (!checkedBoxes || checkedBoxes.length == 0) // can be empty if user did not select a data source
                    {
                        return;
                    }
                    var textFieldData = checkedBoxes[0].value;

                    // set the country code as the connection data so we can get to it when we fetch the data 
                    tableau.connectionData = textFieldData;
                    // name the data source. This will be the data source name in Tableau 
                    tableau.connectionName = 'Weather Forecast Data for ' + textFieldData;
                    tableau.submit();
                });
            });
        })();
    </script>
</head>

<body>

    <!-- Header -->
    <header id="top" class="header">
        <div class="text-vertical-center">
            <h1>Weather Web Data Connector</h1>

            <!-- Input Form -->
            <form id="inputForm" action="">

                <br>
                <label><input type="radio" name="dataSourceName" value="GB" checked> United Kingdom</label>
                <br>
                <label><input type="radio" name="dataSourceName" value="DE"> Germany</label>
                <br>
                <label><input type="radio" name="dataSourceName" value="FR"> France</label>
                <br>
                <label><input type="radio" name="dataSourceName" value="AU"> Australia</label>
                <br>
                <label><input type="radio" name="dataSourceName" value="US"> United States</label>
                <br>
				<label><input type="radio" name="dataSourceName" value="BR"> Brazil</label>
				<br>
                <label><input type="radio" name="dataSourceName" value="ALL"> Global</label>
                <br>
                <input class="btn btn-dark btn-lg" type="submit" value="Get Weather Forecast">
                <h3>5 Day Forecast for Top 300 Cities (by population)</h3>
            </form>
        </div>
    </header>

    <!-- About -->
    <section id="about" class="about">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Weather Web Data Connector</h2>
                    <p class="lead">This Web Data Connector is Powered By <a target="_blank" href="http://openweathermap.org/">OpenWeatherMap</a>.</p>
                </div>
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
    </section>

</body>

</html>
