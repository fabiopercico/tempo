
<html>
<!--******************************************************************************************************/
/** Weather Web Data Connector For Tableau																**/
/** Gets 5 day weather forecast from OpenWeatherMap API for list of cities in chosen country		    **/
/** Author Alex Ross 																					**/
/** Version 1.1 updated for changes to api in 9.1 beta 2            									**/
/** Version 1.2 remove asynchronous calls to openweathermaps due to performance issues					**/
/*******************************************************************************************************-->
<meta http-equiv="Cache-Control" content="no-store" />

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Title Core CSS -->
    <title>Weather Web Data Connector</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/stylish-portfolio.css" rel="stylesheet">

    <!-- Custom Fonts -->
    
    

<script
  src="https://code.jquery.com/jquery-2.2.4.min.js"
  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
  crossorigin="anonymous"></script>

    <script src="js/tableauwdc-1.1.0.js" type="text/javascript"></script>
    <script type="text/javascript">
	
        (function() {
            var APPID = "fa7b25f01dd40c55545750815ddaac5e"; //APPID from OpenWeatherMap.org

            function init() {
                tableau.initCallback();
            }

            function shutdown() {
                tableau.shutdownCallback();
            }

            //returns a URL for 5 day forecast for given city from the OpenWeatherMap API
            function buildUrl(cityid) {
                var url = 'http://api.openweathermap.org/data/2.5/forecast/daily?id=' + encodeURIComponent(cityid.toString()) + "&cnt=5&units=metric" + "&APPID=" + APPID;
                return url;
            }

            var myConnector = tableau.makeConnector();

            myConnector.getColumnHeaders = function() {
                //setup field names and types to store weather data
                var fieldNames = ['COUNTRY', 'CITY ID', 'CITY', 'DAYTEMP', 'MINTEMP', 'MAXTEMP', 'NIGHTTEMP', 'EVETEMP', 'MORNTEMP', 'PRESSURE', 'HUMIDITY', 'DATE', 'MAIN', 'DESCRIPTION', 'ICON', 'SPEED', 'DEGREES', 'CLOUD', 'LAT', 'LON'];
                var fieldTypes = ['string', 'float', 'string', 'float', 'float', 'float', 'float', 'float', 'float', 'float', 'float', 'date', 'string', 'string', 'string', 'float', 'float', 'float', 'float', 'float'];
                tableau.headersCallback(fieldNames, fieldTypes);
            }

            myConnector.getTableData = function(lastRecordToken) {

                if (!tableau) {
                    alert("weatherwebconnect getColumnHeaders- tableau NOT defined!");
                    return;
                }

                //tableau.log("weatherwebconnect - getTableData connectionData=" + tableau.connectionData);
                //tableau.log("weatherwebconnect - getTableData lastRecordToken=" + lastRecordToken);

                //country id selected by user
                var country = tableau.connectionData;

                //define list of top 300 city ids for OpenWeatherMap
                
                if (country == "BR") {
                    var cityids = [
		    3458147,
3453535,
3471393,
3453639,
3450909,
3470127,
3469058,
3396016,
3456283,
3463605,
3471910,
3471039,
3448439,
3925227,
3451190,
3450594,
3452925,
3390760,
3446682,
3453406,
3458449,
3447779,
3445831,
3458131,
3467865,
3465624,
3663517,
3451234,
3454818,
3461655,
3468100,
3453643,
3459462,
3457692,
3453186,
3397277,
3448636,
3403642,
3450083,
3445133,
3462996,
3466704,
3389134,
3457671,
3445782,
3468879,
3469968,
3451152,
3445578,
3456370,
3459505,
3465038,
3392740,
3450269,
3462377,
3395981,
3924679,
3662762,
3662574,
3454244,
3665199,
3456068,
3466537,
3447998,
3446847,
3446130,
3468403,
3446783,
3461444,
3446295,
3464974,
3460102,
3466779,
3467747,
3447785,
3387296,
3447589,
3455671,
3472603,
3462315,
3458696,
3458632,
3445126,
3452324,
3458425,
3460370,
3460728,
3449319,
3388949,
3461786,
3386496,
3457359,
3457487,
3446465,
3458049,
3393001,
3466174,
3448632,
3398269,
3454901,
3471715,
3456166,
3449340,
3454857,
3449696,
3445299,
3449822,
3459035,
3462089,
3465108,
3445679,
3470073,
3468570,
3448063,
3470279,
3449433,
3455161,
3459712,
3471374,
3469173,
3446625,
3450232,
3446692,
3456138,
3458575,
3448403,
3447399,
3472969,
3472248,
3455775,
3460200,
3388660,
3446979,
3472284,
3464739,
3448136,
3461311,
3466429,
3452237,
3446718,
3460620,
3465090,
3470353,
3457381,
3448351,
3446077,
3452525,
3456848,
3448011,
3444876,
3464374,
3472520,
3445433,
3396277,
3458479,
3468615,
3459495,
3464809,
3451328];
                }
             
		    


                //parse lastRecordNumer as Integer as Tableau stores this as a string
                lastRecordToken = Number(lastRecordToken);

                // Return if lastRecordToken is greater than or equal to the size of cityids list
                if (lastRecordToken >= cityids.length) {
                    //if (lastRecordToken > 10) { //test with 10 cities
                    tableau.dataCallback([], lastRecordToken.toString(), false);
                    return;
                }

                var cityid = cityids[lastRecordToken];

				//build url to get data
                var connectionUrl = buildUrl(cityid);

                var xhr = $.ajax({
                    url: connectionUrl,
                    dataType: 'json',
                    success: function(data) {
                        var toRet = [];

                        //make sure we don't output anything for null values
                        if (data.list) {
                            var list = data.list;
                            var city = data.city;

                            //for each result write entry
                            for (x = 0; x < list.length; x++) {

                                //tableau.log("weatherwebconnect - getTableData city=" + city.name);
                                entry = {
                                    'COUNTRY': city.country,
                                    'CITY': city.name,
                                    'CITY ID': city.id,
                                    'DAYTEMP': list[x].temp.day,
                                    'MINTEMP': list[x].temp.min,
                                    'MAXTEMP': list[x].temp.max,
                                    'NIGHTTEMP': list[x].temp.night,
                                    'EVETEMP': list[x].temp.eve,
                                    'MORNTEMP': list[x].temp.morn,
                                    'PRESSURE': list[x].pressure,
                                    'HUMIDITY': list[x].humidity,
                                    'DATE': new Date(list[x].dt * 1000),
                                    'MAIN': list[x].weather[0].main,
                                    'DESCRIPTION': list[x].weather[0].description,
                                    'ICON': list[x].weather[0].icon,
                                    'SPEED': list[x].speed,
                                    'DEGREES': list[x].deg,
                                    'CLOUD': list[x].clouds,
                                    'LAT': city.coord.lat,
                                    'LON': city.coord.lon
                                };
                                toRet.push(entry);
                            }
                            // Call back to tableau with the table data and the new record number (this is stored as a string)
                            lastRecordToken = lastRecordToken + 1;
                            tableau.dataCallback(toRet, lastRecordToken.toString(), true);
                        } else {
                            tableau.abortWithError("No results found for city id: " + cityid);
                        }

                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        // add something to the log and return an empty set if there was problem with the connection
                        tableau.log("connection error: " + xhr.responseText + "\n" + thrownError);
                        tableau.abortWithError("error connecting to the openweathermaps API data source");
                    }
                });
            };

            tableau.registerConnector(myConnector);

            $(document).ready(function() {
                //register some input handlers
                $("#inputForm").submit(function() {
                    // This event fires when a button is clicked 
                    event.preventDefault();
                    var checkedBoxes = $('input[name=dataSourceName]:checked');
                    if (!checkedBoxes || checkedBoxes.length == 0) // can be empty if user did not select a data source
                    {
                        return;
                    }
                    var textFieldData = checkedBoxes[0].value;

                    // set the country code as the connection data so we can get to it when we fetch the data 
                    tableau.connectionData = textFieldData;
                    // name the data source. This will be the data source name in Tableau 
                    tableau.connectionName = 'Weather Forecast Data for ' + textFieldData;
                    tableau.submit();
                });
            });
        })();
    </script>
</head>

<body>

    <!-- Header -->
    <header id="top" class="header">
        <div class="text-vertical-center">
            <h1>Weather Web Data Connector</h1>

            <!-- Input Form -->
            <form id="inputForm" action="">

                <br>
                <label><input type="radio" name="dataSourceName" value="BR"> France</label>
            
                <br>
                <input class="btn btn-dark btn-lg" type="submit" value="Get Weather Forecast">
                <h3>5 Day Forecast for Top 300 Cities (by population)</h3>
            </form>
        </div>
    </header>

    <!-- About -->
    <section id="about" class="about">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Weather Web Data Connector</h2>
                    <p class="lead">This Web Data Connector is Powered By <a target="_blank" href="http://openweathermap.org/">OpenWeatherMap</a>.</p>
                </div>
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
    </section>

</body>

</html>
